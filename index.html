<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ° ç™¾å®¶æ¨‚ç®—ç‰Œåˆ†æå·¥å…· v3.1 - è·‘ç‰Œå€¼é æ¸¬ç‰ˆ</title>
    <style>
        :root {
            --color-primary: #2180a6;
            --color-primary-hover: #1a6684;
            --color-success: #22b85e;
            --color-error: #c01530;
            --color-warning: #ff6b35;
            --color-bg: #fcfcf9;
            --color-surface: #ffffff;
            --color-text: #134252;
            --color-border: #d4d4d0;
            --color-card-bg: #f5f5f5;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --radius-base: 8px;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: var(--space-20);
            line-height: 1.6;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 {
            text-align: center;
            color: var(--color-primary);
            margin-bottom: var(--space-24);
            font-size: 28px;
        }
        .game-section {
            background-color: var(--color-surface);
            border-radius: var(--radius-base);
            padding: var(--space-24);
            margin-bottom: var(--space-24);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: var(--space-16);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .card-input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-20);
        }
        .card-input { display: flex; flex-direction: column; }
        label {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #666;
            text-transform: uppercase;
        }
        .card-select {
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            font-size: 14px;
            background-color: white;
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.2s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 32px;
        }
        .card-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.2);
        }
        .button-group { display: flex; gap: var(--space-16); margin-top: var(--space-20); }
        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-base);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-calculate { background-color: var(--color-primary); color: white; }
        .btn-calculate:hover { background-color: var(--color-primary-hover); }
        .btn-reset { background-color: #f0f0f0; color: var(--color-text); border: 1px solid var(--color-border); }
        .btn-reset:hover { background-color: #e0e0e0; }
        .result-section {
            background-color: var(--color-card-bg);
            border-radius: var(--radius-base);
            padding: var(--space-24);
            border-left: 4px solid var(--color-primary);
            margin-top: var(--space-24);
        }
        .result-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-20);
            margin-bottom: var(--space-20);
            padding-bottom: var(--space-20);
            border-bottom: 1px solid var(--color-border);
        }
        .result-row:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .result-item { display: flex; flex-direction: column; }
        .result-label { font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 6px; font-weight: 500; }
        .result-value { font-size: 24px; font-weight: 600; color: var(--color-text); }
        .result-value.positive { color: var(--color-success); }
        .result-value.negative { color: var(--color-error); }
        .recommendation {
            background-color: white;
            border-radius: var(--radius-base);
            padding: var(--space-20);
            margin-top: var(--space-20);
            text-align: center;
            border: 2px solid var(--color-border);
        }
        .recommendation.player { border-color: var(--color-success); background-color: rgba(34, 184, 94, 0.05); }
        .recommendation.banker { border-color: var(--color-error); background-color: rgba(192, 21, 47, 0.05); }
        .recommendation-title { font-size: 12px; color: #666; margin-bottom: 8px; text-transform: uppercase; font-weight: 500; }
        .recommendation-text { font-size: 20px; font-weight: 700; }
        .recommendation.player .recommendation-text { color: var(--color-success); }
        .recommendation.banker .recommendation-text { color: var(--color-error); }
        .hidden { display: none; }
        .btn-result {
            padding: 12px 20px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-base);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background-color: white;
            color: var(--color-text);
            transition: all 0.2s;
        }
        .btn-result:hover { border-color: var(--color-primary); color: var(--color-primary); }
        .btn-result-active { border-color: var(--color-primary); background-color: var(--color-primary); color: white; }
        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            margin-bottom: 8px;
            background-color: white;
        }
        .history-item-info { flex: 1; }
        .history-item-game { font-size: 12px; color: #999; margin-bottom: 4px; }
        .history-item-recommendation { font-size: 13px; font-weight: 500; color: var(--color-text); margin-bottom: 4px; }
        .history-item-result { font-size: 12px; color: #666; }
        .history-item-status { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-badge.correct { background-color: rgba(34, 184, 94, 0.15); color: var(--color-success); }
        .status-badge.fail { background-color: rgba(192, 21, 47, 0.15); color: var(--color-error); }
        .pattern-history {
            background-color: #fff3cd;
            border: 2px solid var(--color-warning);
            border-radius: var(--radius-base);
            padding: var(--space-20);
            margin: var(--space-20) 0;
        }
        .pattern-key {
            font-family: monospace;
            font-size: 14px;
            color: var(--color-primary);
            margin-bottom: var(--space-12);
            padding: var(--space-8);
            background: rgba(33, 128, 166, 0.1);
            border-radius: var(--radius-base);
        }
        .pattern-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-16); }
        .pattern-stat { text-align: center; }
        .pattern-stat-number { font-size: 20px; font-weight: 700; color: var(--color-primary); }
        .database-section {
            background-color: var(--color-card-bg);
            border-radius: var(--radius-base);
            padding: var(--space-20);
            margin-bottom: var(--space-24);
        }
        .database-actions { display: flex; gap: var(--space-16); margin-bottom: var(--space-20); flex-wrap: wrap; }
        .btn-database { padding: 10px 16px; font-size: 13px; }
        .roadmap-prediction {
            background-color: white;
            border-radius: var(--radius-base);
            padding: var(--space-20);
            margin-top: var(--space-20);
            text-align: center;
            border: 2px solid #ff6b35;
            background-color: rgba(255, 107, 53, 0.05);
        }
        .roadmap-title { font-size: 12px; color: #ff6b35; margin-bottom: 8px; text-transform: uppercase; font-weight: 600; }
        .prediction-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-16); margin-bottom: var(--space-16); }
        .prediction-item { text-align: center; }
        .prediction-label { font-size: 12px; color: #666; margin-bottom: 4px; }
        .prediction-value { font-size: 20px; font-weight: 600; }
        @media (max-width: 600px) {
            h1 { font-size: 22px; }
            .game-section { padding: var(--space-16); }
            .card-input-group { grid-template-columns: repeat(3, 1fr); }
            .result-row { grid-template-columns: 1fr; }
            .pattern-stats { grid-template-columns: 1fr; }
            .database-actions { flex-direction: column; }
            .prediction-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ° ç™¾å®¶æ¨‚ç®—ç‰Œåˆ†æå·¥å…· v3.1</h1>
        
        <div class="database-section">
            <div class="section-title">ğŸ“Š æ•¸æ“šä¸­å¿ƒ</div>
            <div class="database-actions">
                <button class="btn-reset btn-database" onclick="exportToExcel()">ğŸ“Š åŒ¯å‡ºExcel</button>
                <button class="btn-reset btn-database" onclick="showAnalytics()">ğŸ“ˆ åˆ†æå ±è¡¨</button>
                <button class="btn-reset btn-database" onclick="importDataBatch()">ğŸ“¥ æ‰¹é‡å°å…¥</button>
                <button class="btn-calculate btn-database" onclick="showTopPatterns()">ğŸ”¥ Topç‰Œå±€</button>
            </div>
            <div id="databaseInfo" style="font-size: 14px; color: #666;">
                è³‡æ–™åº«: <span id="totalPatterns">0</span> ç‰Œå‹ | <span id="totalRecords">0</span> ç­† | å‹ç‡: <span id="totalWinRate" style="color: var(--color-success); font-weight: 600;">-</span>
            </div>
        </div>

        <div class="game-section">
            <div class="section-title">é–’å®¶ç‰Œ</div>
            <div class="card-input-group">
                <div class="card-input">
                    <label>ç¬¬1å¼µ</label>
                    <select id="player1" class="card-select">
                        <option value="">é¸æ“‡</option>
                        <option value="1">A</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="0">10</option>
                        <option value="0">J</option>
                        <option value="0">Q</option>
                        <option value="0">K</option>
                    </select>
                </div>
                <div class="card-input">
                    <label>ç¬¬2å¼µ</label>
                    <select id="player2" class="card-select">
                        <option value="">é¸æ“‡</option>
                        <option value="1">A</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="0">10</option>
                        <option value="0">J</option>
                        <option value="0">Q</option>
                        <option value="0">K</option>
                    </select>
                </div>
                <div class="card-input">
                    <label>ç¬¬3å¼µ</label>
                    <select id="player3" class="card-select">
                        <option value="">é¸æ“‡</option>
                        <option value="1">A</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="0">10</option>
                        <option value="0">J</option>
                        <option value="0">Q</option>
                        <option value="0">K</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="game-section">
            <div class="section-title">èŠå®¶ç‰Œ</div>
            <div class="card-input-group">
                <div class="card-input">
                    <label>ç¬¬1å¼µ</label>
                    <select id="banker1" class="card-select">
                        <option value="">é¸æ“‡</option>
                        <option value="1">A</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="0">10</option>
                        <option value="0">J</option>
                        <option value="0">Q</option>
                        <option value="0">K</option>
                    </select>
                </div>
                <div class="card-input">
                    <label>ç¬¬2å¼µ</label>
                    <select id="banker2" class="card-select">
                        <option value="">é¸æ“‡</option>
                        <option value="1">A</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="0">10</option>
                        <option value="0">J</option>
                        <option value="0">Q</option>
                        <option value="0">K</option>
                    </select>
                </div>
                <div class="card-input">
                    <label>ç¬¬3å¼µ</label>
                    <select id="banker3" class="card-select">
                        <option value="">é¸æ“‡</option>
                        <option value="1">A</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="0">10</option>
                        <option value="0">J</option>
                        <option value="0">Q</option>
                        <option value="0">K</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-calculate" onclick="calculateBaccarat()">è¨ˆç®—çµæœ</button>
            <button class="btn-reset" onclick="resetForm()">æ¸…é™¤é‡è¨­</button>
        </div>

        <div id="results" class="hidden">
            <div id="patternHistorySection" class="pattern-history hidden"></div>
            
            <div class="result-section">
                <div class="result-row">
                    <div class="result-item">
                        <div class="result-label">é–’å®¶é»æ•¸</div>
                        <div class="result-value" id="playerPoints">-</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">èŠå®¶é»æ•¸</div>
                        <div class="result-value" id="bankerPoints">-</div>
                    </div>
                </div>
                <div class="result-row">
                    <div class="result-item">
                        <div class="result-label">å…¬ç‰Œæ•¸é‡</div>
                        <div class="result-value" id="publicCards">-</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">å…¬ç‰Œé¡å‹</div>
                        <div class="result-value" id="publicType">-</div>
                    </div>
                </div>
                <div class="result-row">
                    <div class="result-item">
                        <div class="result-label">åŸºç¤é»å·®</div>
                        <div class="result-value" id="baseDiff">-</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">æœ€çµ‚çµæœ</div>
                        <div class="result-value" id="finalResult">-</div>
                    </div>
                </div>
            </div>

            <div id="recommendation" class="recommendation">
                <div class="recommendation-title">æœ¬å±€æŠ•æ³¨å»ºè­°</div>
                <div class="recommendation-text" id="recommendationText">-</div>
            </div>

            <div class="roadmap-prediction">
                <div class="roadmap-title">ğŸ”® è·‘ç‰Œå€¼é æ¸¬ï¼ˆä¸‹ä¸€å±€ï¼‰</div>
                <div class="prediction-grid">
                    <div class="prediction-item">
                        <div class="prediction-label">é–’å®¶å°¾æ•¸</div>
                        <div class="prediction-value" id="playerTailDisplay" style="color: var(--color-success);">-</div>
                    </div>
                    <div class="prediction-item">
                        <div class="prediction-label">èŠå®¶å°¾æ•¸</div>
                        <div class="prediction-value" id="bankerTailDisplay" style="color: var(--color-error);">-</div>
                    </div>
                </div>
                <div style="background: #fff9f0; padding: var(--space-12); border-radius: var(--radius-base); margin-bottom: var(--space-12);">
                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">å°¾æ•¸ç›¸åŠ </div>
                    <div style="font-size: 20px; font-weight: 600; color: #ff6b35;" id="tailSumDisplay">-</div>
                </div>
                <div style="background: #f5f5f5; padding: var(--space-12); border-radius: var(--radius-base); margin-bottom: var(--space-12);">
                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">åˆæ­¥é æ¸¬</div>
                    <div style="font-size: 16px; font-weight: 600;" id="initialPredictionDisplay">-</div>
                </div>
                <div style="background: #f0f8ff; padding: var(--space-12); border-radius: var(--radius-base); margin-bottom: var(--space-12);">
                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">èª¿æ•´ä¿¡æ¯</div>
                    <div style="font-size: 13px; color: #2180a6;" id="adjustmentInfoDisplay">-</div>
                </div>
                <div style="border-top: 2px solid #ff6b35; padding-top: var(--space-12); text-align: center;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 6px;">æœ€çµ‚é æ¸¬</div>
                    <div style="font-size: 24px; font-weight: 700; color: #ff6b35;" id="finalRoadmapPredictionText">-</div>
                </div>
            </div>

            <div id="feedbackSection" class="hidden" style="margin-top: var(--space-24);">
                <div class="result-section" style="border-left: 4px solid var(--color-warning);">
                    <div class="section-title">ç‰Œå±€çµæœ</div>
                    <div style="display: flex; gap: var(--space-16); margin-bottom: var(--space-20);">
                        <button id="resultPlayer" class="btn-result btn-result-active" onclick="recordResult('player')" style="flex: 1;">é–‹é–’</button>
                        <button id="resultBanker" class="btn-result" onclick="recordResult('banker')" style="flex: 1;">é–‹èŠ</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="game-section" id="historySection" style="margin-top: var(--space-24);">
            <div class="section-title">ç‰Œå±€ç´€éŒ„ <span id="gameCount" style="color: var(--color-primary);">(0)</span></div>
            <div id="historyList" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-base); padding: var(--space-16);">
                <div style="text-align: center; color: #999; padding: var(--space-20);">é‚„ç„¡ç´€éŒ„</div>
            </div>
            <div style="display: flex; gap: var(--space-16); margin-top: var(--space-16);">
                <div style="flex: 1;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 6px;">æº–ç¢ºåº¦</div>
                    <div style="font-size: 24px; font-weight: 600; color: var(--color-success);" id="accuracyDisplay">-</div>
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 6px;">æº–ç¢ºå±€æ•¸</div>
                    <div style="font-size: 24px; font-weight: 600; color: var(--color-success);" id="correctCount">-</div>
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 6px;">å¤±æ•—å±€æ•¸</div>
                    <div style="font-size: 24px; font-weight: 600; color: var(--color-error);" id="failCount">-</div>
                </div>
            </div>
            <button class="btn-reset" onclick="clearAllData()" style="width: 100%; margin-top: var(--space-16);">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
        </div>
    </div>

    <script>
        let gameHistory = [];
        let currentRecommendation = '';
        let currentPatternKey = '';
        let patternDatabase = {};

        window.addEventListener('load', function() {
            loadPatternDatabase();
            updateHistoryDisplay();
            updateDatabaseInfo();
        });

        function generatePatternKey() {
            const p1 = document.getElementById('player1').value || '-';
            const p2 = document.getElementById('player2').value || '-';
            const p3 = document.getElementById('player3').value || '-';
            const b1 = document.getElementById('banker1').value || '-';
            const b2 = document.getElementById('banker2').value || '-';
            const b3 = document.getElementById('banker3').value || '-';
            return `P:${p1}-${p2}-${p3}|B:${b1}-${b2}-${b3}`;
        }

        function loadPatternDatabase() {
            const data = localStorage.getItem('baccaratPatterns');
            if (data) {
                patternDatabase = JSON.parse(data);
            }
        }

        function savePatternDatabase() {
            localStorage.setItem('baccaratPatterns', JSON.stringify(patternDatabase));
            updateDatabaseInfo();
        }

        function updateDatabaseInfo() {
            let totalPatterns = Object.keys(patternDatabase).length;
            let totalRecords = 0;
            let correctRecords = 0;
            Object.values(patternDatabase).forEach(records => {
                totalRecords += records.length;
                correctRecords += records.filter(r => r.correct).length;
            });
            document.getElementById('totalPatterns').textContent = totalPatterns;
            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('totalWinRate').textContent = totalRecords > 0 ? 
                ((correctRecords / totalRecords) * 100).toFixed(1) + '%' : '-';
        }

        function showPatternHistory(patternKey) {
            const section = document.getElementById('patternHistorySection');
            const records = patternDatabase[patternKey] || [];
            
            if (records.length === 0) {
                section.innerHTML = '<div style="text-align: center; color: #999;">æ­¤ç‰Œå±€ç„¡æ­·å²ç´€éŒ„</div>';
            } else {
                const playerWins = records.filter(r => r.result === 'é–‹é–’').length;
                const bankerWins = records.length - playerWins;
                const correctRate = records.filter(r => r.correct).length / records.length * 100;
                
                section.innerHTML = `
                    <div class="pattern-key">${patternKey}</div>
                    <div class="pattern-stats">
                        <div class="pattern-stat">
                            <div class="pattern-stat-number">${records.length}æ¬¡</div>
                            <div style="font-size: 12px; color: #666;">æ­·å²å‡ºç¾</div>
                        </div>
                        <div class="pattern-stat">
                            <div class="pattern-stat-number">${playerWins}æ¬¡ (${Math.round(playerWins/records.length*100)}%)</div>
                            <div style="font-size: 12px; color: var(--color-success);">é–‹é–’</div>
                        </div>
                        <div class="pattern-stat">
                            <div class="pattern-stat-number">${bankerWins}æ¬¡ (${Math.round(bankerWins/records.length*100)}%)</div>
                            <div style="font-size: 12px; color: var(--color-error);">é–‹èŠ</div>
                        </div>
                    </div>
                    <div style="margin-top: var(--space-16); padding: var(--space-12); background: rgba(255,255,255,0.8); border-radius: var(--radius-base);">
                        <div style="font-size: 14px; font-weight: 600; color: var(--color-primary);">æº–ç¢ºç‡: ${Math.round(correctRate)}%</div>
                    </div>
                `;
            }
            section.classList.remove('hidden');
        }

        function calculateBaccarat() {
            const player1Val = document.getElementById('player1').value;
            const player2Val = document.getElementById('player2').value;
            const player3Val = document.getElementById('player3').value;
            const banker1Val = document.getElementById('banker1').value;
            const banker2Val = document.getElementById('banker2').value;
            const banker3Val = document.getElementById('banker3').value;

            if (!player1Val || !player2Val || !banker1Val || !banker2Val) {
                alert('è«‹è‡³å°‘è¼¸å…¥é–’å®¶å’ŒèŠå®¶çš„å‰å…©å¼µç‰Œ');
                return;
            }

            const player1 = parseInt(player1Val) || 0;
            const player2 = parseInt(player2Val) || 0;
            const player3 = player3Val ? (parseInt(player3Val) || 0) : 0;
            const banker1 = parseInt(banker1Val) || 0;
            const banker2 = parseInt(banker2Val) || 0;
            const banker3 = banker3Val ? (parseInt(banker3Val) || 0) : 0;

            const playerTotal = player1 + player2 + player3;
            const bankerTotal = banker1 + banker2 + banker3;

            const selectedCards = [
                player1Val ? parseInt(player1Val) : null,
                player2Val ? parseInt(player2Val) : null,
                player3Val ? parseInt(player3Val) : null,
                banker1Val ? parseInt(banker1Val) : null,
                banker2Val ? parseInt(banker2Val) : null,
                banker3Val ? parseInt(banker3Val) : null
            ];
            const publicCardCount = selectedCards.filter(card => card === 0).length;

            const baseDiff = playerTotal - bankerTotal;
            const baseDiffSign = baseDiff >= 0 ? 1 : -1;
            const publicCardSign = publicCardCount % 2 === 0 ? 1 : -1;
            const finalSign = baseDiffSign * publicCardSign;
            const absDiff = Math.abs(baseDiff);
            const finalResult = absDiff * finalSign;

            const isPlayer = finalResult > 0;
            const recommendation = isPlayer ? 'æŠ•æ³¨é–’å®¶' : 'æŠ•æ³¨èŠå®¶';
            const recommendationClass = isPlayer ? 'player' : 'banker';

            currentPatternKey = generatePatternKey();
            showPatternHistory(currentPatternKey);

            document.getElementById('playerPoints').textContent = playerTotal;
            document.getElementById('bankerPoints').textContent = bankerTotal;
            document.getElementById('publicCards').textContent = publicCardCount + ' å¼µ';
            document.getElementById('publicType').textContent = publicCardCount % 2 === 0 ? 'å¶æ•¸ï¼ˆæ­£ï¼‰' : 'å–®æ•¸ï¼ˆè² ï¼‰';
            document.getElementById('baseDiff').textContent = baseDiff > 0 ? '+' + baseDiff : baseDiff;
            
            const finalResultElement = document.getElementById('finalResult');
            finalResultElement.textContent = finalResult > 0 ? '+' + finalResult : finalResult;
            finalResultElement.className = 'result-value ' + (finalResult > 0 ? 'positive' : 'negative');

            const recommendationDiv = document.getElementById('recommendation');
            recommendationDiv.className = 'recommendation ' + recommendationClass;
            document.getElementById('recommendationText').textContent = recommendation;

            currentRecommendation = recommendation;
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('feedbackSection').classList.remove('hidden');

            document.getElementById('resultPlayer').classList.remove('btn-result-active');
            document.getElementById('resultBanker').classList.remove('btn-result-active');
            document.getElementById('resultPlayer').classList.add('btn-result-active');

            calculateRoadmapPrediction(player1, player2, player3, banker1, banker2, banker3);
        }

        function calculateRoadmapPrediction(p1, p2, p3, b1, b2, b3) {
            // è¨ˆç®—å°¾æ•¸ (A=1, 2-9åŸå€¼, 10/JQK=0)
            const getTailNumber = (num) => {
                if (num === 0) return 0;
                return num % 10;
            };

            const playerTail = (getTailNumber(p1) + getTailNumber(p2) + getTailNumber(p3)) % 10;
            const bankerTail = (getTailNumber(b1) + getTailNumber(b2) + getTailNumber(b3)) % 10;
            const tailSum = playerTail + bankerTail;

            // åˆæ­¥é æ¸¬
            let initialPrediction = '';
            let initialColor = '';
            if (tailSum >= 1 && tailSum <= 9) {
                initialPrediction = 'ä¸‹ä¸€å±€é–‹é–’';
                initialColor = 'var(--color-success)';
            } else if (tailSum >= 10 && tailSum <= 18) {
                initialPrediction = 'ä¸‹ä¸€å±€é–‹èŠ';
                initialColor = 'var(--color-error)';
            }

            // æ ¹æ“šå¼µæ•¸å’Œé«˜ç‰Œèª¿æ•´
            const cards = [p1, p2, p3, b1, b2, b3].filter(c => c !== null && c !== '' && c !== 0 || c === 0);
            const allCards = [p1, p2, p3, b1, b2, b3].filter(c => c !== null && c !== '');
            const totalCards = allCards.length;
            const hasHighCard = allCards.some(c => c === 0);

            let finalPrediction = initialPrediction;
            let adjustmentInfo = '';

            if (totalCards >= 5 && totalCards <= 6) {
                finalPrediction = initialPrediction === 'ä¸‹ä¸€å±€é–‹é–’' ? 'ä¸‹ä¸€å±€é–‹èŠ' : 'ä¸‹ä¸€å±€é–‹é–’';
                adjustmentInfo = `${totalCards}å¼µ â†’ åè½‰é æ¸¬`;
            } else if (totalCards === 4) {
                if (!hasHighCard) {
                    finalPrediction = initialPrediction === 'ä¸‹ä¸€å±€é–‹é–’' ? 'ä¸‹ä¸€å±€é–‹èŠ' : 'ä¸‹ä¸€å±€é–‹é–’';
                    adjustmentInfo = '4å¼µç„¡é«˜ç‰Œ â†’ åè½‰';
                } else {
                    adjustmentInfo = '4å¼µæœ‰é«˜ç‰Œ â†’ ä¸è®Š';
                }
            } else {
                adjustmentInfo = `${totalCards}å¼µ â†’ ä¸èª¿æ•´`;
            }

            document.getElementById('playerTailDisplay').textContent = playerTail;
            document.getElementById('bankerTailDisplay').textContent = bankerTail;
            document.getElementById('tailSumDisplay').textContent = `${playerTail} + ${bankerTail} = ${tailSum}`;
            
            const initialPredDiv = document.getElementById('initialPredictionDisplay');
            initialPredDiv.textContent = initialPrediction;
            initialPredDiv.style.color = initialColor;

            document.getElementById('adjustmentInfoDisplay').textContent = adjustmentInfo;

            const finalPredDiv = document.getElementById('finalRoadmapPredictionText');
            finalPredDiv.textContent = finalPrediction;
            finalPredDiv.style.color = finalPrediction === 'ä¸‹ä¸€å±€é–‹é–’' ? 'var(--color-success)' : 'var(--color-error)';
        }

        function recordResult(result) {
            if (!currentRecommendation || !currentPatternKey) {
                alert('è«‹å…ˆè¨ˆç®—çµæœ');
                return;
            }

            const isCorrect = (result === 'player' && currentRecommendation === 'æŠ•æ³¨é–’å®¶') ||
                            (result === 'banker' && currentRecommendation === 'æŠ•æ³¨èŠå®¶');

            gameHistory.push({
                game: gameHistory.length + 1,
                recommendation: currentRecommendation,
                result: result === 'player' ? 'é–‹é–’' : 'é–‹èŠ',
                correct: isCorrect,
                timestamp: Date.now()
            });

            if (!patternDatabase[currentPatternKey]) {
                patternDatabase[currentPatternKey] = [];
            }
            patternDatabase[currentPatternKey].push({
                recommend: currentRecommendation,
                result: result === 'player' ? 'é–‹é–’' : 'é–‹èŠ',
                correct: isCorrect,
                timestamp: Date.now()
            });
            savePatternDatabase();

            updateHistoryDisplay();
            updateStatistics();

            resetForm();
            document.getElementById('feedbackSection').classList.add('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('patternHistorySection').classList.add('hidden');
        }

        function resetForm() {
            document.getElementById('player1').value = '';
            document.getElementById('player2').value = '';
            document.getElementById('player3').value = '';
            document.getElementById('banker1').value = '';
            document.getElementById('banker2').value = '';
            document.getElementById('banker3').value = '';
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            const gameCount = document.getElementById('gameCount');

            if (gameHistory.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; color: #999; padding: var(--space-20);">é‚„ç„¡ç´€éŒ„</div>';
                gameCount.textContent = '(0)';
                return;
            }

            gameCount.textContent = '(' + gameHistory.length + ')';
            historyList.innerHTML = gameHistory.slice().reverse().map((game) => `
                <div class="history-item">
                    <div class="history-item-info">
                        <div class="history-item-game">ç¬¬ ${game.game} å±€</div>
                        <div class="history-item-recommendation">å»ºè­°: ${game.recommendation}</div>
                        <div class="history-item-result">çµæœ: ${game.result}</div>
                    </div>
                    <div class="history-item-status">
                        <div class="status-badge ${game.correct ? 'correct' : 'fail'}">
                            ${game.correct ? 'âœ“ æº–' : 'âœ— å¤±æ•—'}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStatistics() {
            const total = gameHistory.length;
            const correct = gameHistory.filter(g => g.correct).length;
            const fail = total - correct;
            const accuracy = total > 0 ? ((correct / total) * 100).toFixed(1) : 0;

            document.getElementById('accuracyDisplay').textContent = accuracy + '%';
            document.getElementById('correctCount').textContent = correct;
            document.getElementById('failCount').textContent = fail;
        }

        function exportToExcel() {
            if (gameHistory.length === 0) {
                alert('æš«ç„¡æ•¸æ“šå¯åŒ¯å‡º');
                return;
            }

            let csv = 'å±€æ•¸,æŠ•æ³¨å»ºè­°,å¯¦éš›çµæœ,æ˜¯å¦æ­£ç¢º,æ™‚é–“\n';
            gameHistory.forEach((game) => {
                const timeStr = game.timestamp ? new Date(game.timestamp).toLocaleString('zh-TW') : '-';
                csv += `${game.game},${game.recommendation},${game.result},${game.correct ? 'æ­£ç¢º' : 'å¤±æ•—'},${timeStr}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `baccarat_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        function showAnalytics() {
            const total = gameHistory.length;
            if (total === 0) {
                alert('æš«ç„¡æ•¸æ“šå¯åˆ†æ');
                return;
            }

            const correct = gameHistory.filter(g => g.correct).length;
            const playerGames = gameHistory.filter(g => g.recommendation === 'æŠ•æ³¨é–’å®¶');
            const bankerGames = gameHistory.filter(g => g.recommendation === 'æŠ•æ³¨èŠå®¶');

            let report = `ğŸ“Š åˆ†æå ±è¡¨\nç¸½å±€æ•¸: ${total}\næ•´é«”å‹ç‡: ${((correct/total)*100).toFixed(1)}%\n\n`;
            report += `é–’å®¶: ${playerGames.length}å±€ (${playerGames.length > 0 ? ((playerGames.filter(g=>g.correct).length/playerGames.length)*100).toFixed(1) : 0}%)\n`;
            report += `èŠå®¶: ${bankerGames.length}å±€ (${bankerGames.length > 0 ? ((bankerGames.filter(g=>g.correct).length/bankerGames.length)*100).toFixed(1) : 0}%)`;

            alert(report);
        }

        function importDataBatch() {
            const input = prompt('è²¼å…¥æ•¸æ“š (æ ¼å¼: æŠ•æ³¨é–’å®¶,é–‹é–’ æ¯è¡Œä¸€ç­†)');
            if (!input) return;

            const lines = input.trim().split('\n');
            let count = 0;

            lines.forEach(line => {
                const [recommend, result] = line.split(',').map(s => s.trim());
                if (recommend && result) {
                    const isCorrect = (recommend === 'æŠ•æ³¨é–’å®¶' && result === 'é–‹é–’') ||
                                     (recommend === 'æŠ•æ³¨èŠå®¶' && result === 'é–‹èŠ');
                    gameHistory.push({
                        game: gameHistory.length + 1,
                        recommendation: recommend,
                        result: result,
                        correct: isCorrect,
                        timestamp: Date.now()
                    });
                    count++;
                }
            });

            if (count > 0) {
                updateHistoryDisplay();
                updateStatistics();
                alert(`æˆåŠŸå°å…¥ ${count} ç­†`);
            }
        }

        function showTopPatterns() {
            const sorted = Object.entries(patternDatabase)
                .sort(([,a], [,b]) => b.length - a.length)
                .slice(0, 10);
            
            let html = 'Top 10 ç‰Œå±€\n\n';
            sorted.forEach(([key, records]) => {
                const playerWins = records.filter(r => r.result === 'é–‹é–’').length;
                html += `${key}: ${records.length}æ¬¡ (${Math.round(playerWins/records.length*100)}%é–‹é–’)\n`;
            });

            alert(html);
        }

        function clearAllData() {
            if (confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼Ÿ')) {
                if (confirm('å†æ¬¡ç¢ºèª')) {
                    gameHistory = [];
                    patternDatabase = {};
                    localStorage.clear();
                    updateHistoryDisplay();
                    updateStatistics();
                    updateDatabaseInfo();
                }
            }
        }

        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                calculateBaccarat();
            }
        });
    </script>
</body>
</html>
